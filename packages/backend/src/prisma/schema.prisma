// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  MANAGER
  EMPLOYEE
  RETAILER
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum CropYear {
  NEW_CROP
  OLD_CROP
}

enum ContractType {
  CASH
  BASIS
  HTA
  ACCUMULATOR
}

enum CommodityType {
  CORN
  SOYBEANS
  WHEAT
}

enum BidRequestStatus {
  OPEN
  CLOSED
}

enum ScaleTicketStatus {
  PENDING
  PARSED
  FAILED
  PROCESSED
}

enum GrainPurchaseOfferStatus {
  PENDING    // Retailer submitted offer to farmer
  ACCEPTED   // Farmer accepted the offer
  REJECTED   // Farmer rejected the offer
  EXPIRED    // Offer expired
  COMPLETED  // Transaction completed
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  role          UserRole
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  businessMemberships BusinessMember[]
  calendarEvents      CalendarEvent[]
  createdTasks        Task[]          @relation("TaskCreator")
  assignedTasks       Task[]          @relation("TaskAssignee")
  taskComments        TaskComment[]
  refreshTokens       RefreshToken[]
  pushSubscriptions   PushSubscription[]
  grainContracts      GrainContract[]
  priceAlerts         PriceAlert[]
  retailerProfile     Retailer?
  createdBidRequests  BidRequest[]
  createdInvitations  BusinessInvitation[] @relation("InvitationCreator")
  usedInvitations     BusinessInvitation[] @relation("InvitationUser")
  uploadedInvoices    Invoice[]       @relation("InvoiceUploader")
  uploadedScaleTickets ScaleTicket[]  @relation("ScaleTicketUploader")
  binTransactions     BinTransaction[] @relation("BinTransactionCreator")
  marketingProfile    UserMarketingProfile?

  @@map("users")
}

model Business {
  id        String   @id @default(uuid())
  name      String
  address   String?  // Street address for deliveries
  city      String?
  state     String?
  zipCode   String?  @map("zip_code")
  phone     String?  // Contact phone for delivery coordination
  email     String?  // Contact email for delivery coordination
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members              BusinessMember[]
  calendarEvents       CalendarEvent[]
  tasks                Task[]
  grainEntities        GrainEntity[]
  priceAlerts          PriceAlert[]
  fertilizers          Fertilizer[]
  chemicals            Chemical[]
  seedHybrids          SeedHybrid[]
  bidRequests          BidRequest[]
  invitations          BusinessInvitation[]
  invoices             Invoice[]
  purchaseHistory      PurchaseHistory[]
  scaleTickets         ScaleTicket[]
  subscription         BusinessSubscription?
  marketingPreferences MarketingPreferences?

  @@index([latitude, longitude])
  @@index([deletedAt])
  @@map("businesses")
}

model BusinessMember {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  businessId String   @map("business_id")
  role       UserRole
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@map("business_members")
}

model BusinessInvitation {
  id             String    @id @default(uuid())
  businessId     String    @map("business_id")
  code           String    @unique // 8-character alphanumeric code
  role           UserRole  // Role the invitee will have (MANAGER or EMPLOYEE)
  createdBy      String    @map("created_by")
  email          String?   // Optional: specific email to restrict invitation
  expiresAt      DateTime  @map("expires_at")
  usedAt         DateTime? @map("used_at")
  usedBy         String?   @map("used_by")
  isActive       Boolean   @default(true) @map("is_active")
  maxUses        Int       @default(1) @map("max_uses") // How many times can this code be used
  currentUses    Int       @default(0) @map("current_uses")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator  User     @relation("InvitationCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  user     User?    @relation("InvitationUser", fields: [usedBy], references: [id])

  @@index([businessId])
  @@index([code])
  @@index([createdBy])
  @@map("business_invitations")
}

model CalendarEvent {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  userId      String   @map("user_id")
  title       String
  description String?
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  allDay      Boolean  @default(false) @map("all_day")
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([businessId, startTime])
  @@index([userId, startTime])
  @@map("calendar_events")
}

model Task {
  id           String       @id @default(uuid())
  businessId   String       @map("business_id")
  createdBy    String       @map("created_by")
  assignedTo   String?      @map("assigned_to")
  title        String
  description  String?
  status       TaskStatus   @default(OPEN)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?    @map("due_date")
  completedAt  DateTime?    @map("completed_at")
  isClaimable  Boolean      @default(false) @map("is_claimable")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  business Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator  User          @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  assignee User?         @relation("TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  comments TaskComment[]

  @@index([businessId, status])
  @@index([assignedTo, status])
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_comments")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model PushSubscription {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  endpoint   String   @unique
  p256dh     String   // Public key for encryption
  auth       String   // Authentication secret
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model GrainEntity {
  id         String   @id @default(uuid())
  businessId String   @map("business_id")
  name       String   // Rittgers Grain, Rittgers Farm, JDR AG, JVR AG, JKC Farms
  deletedAt  DateTime? @map("deleted_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business              @relation(fields: [businessId], references: [id], onDelete: Cascade)
  contracts   GrainContract[]
  productions CropYearProduction[]
  farms       Farm[]
  grainBins   GrainBin[]

  @@unique([businessId, name])
  @@index([businessId])
  @@index([deletedAt])
  @@map("grain_entities")
}

model GrainContract {
  id                 String         @id @default(uuid())
  grainEntityId      String         @map("grain_entity_id")
  createdBy          String         @map("created_by")
  contractType       ContractType   @map("contract_type")
  cropYear           CropYear       @map("crop_year")
  year               Int            @default(2025) // Actual year: 2024, 2025, 2026, etc.
  commodityType      CommodityType  @map("commodity_type")
  contractNumber     String?        @map("contract_number")
  buyer              String         // Elevator/Buyer name
  totalBushels       Decimal        @map("total_bushels") @db.Decimal(12, 2)
  deliveryStartDate  DateTime?      @map("delivery_start_date")
  deliveryEndDate    DateTime?      @map("delivery_end_date")

  // Pricing fields
  cashPrice          Decimal?       @map("cash_price") @db.Decimal(10, 4)
  basisPrice         Decimal?       @map("basis_price") @db.Decimal(10, 4)
  futuresMonth       String?        @map("futures_month") // e.g., "Dec 2024"
  futuresPrice       Decimal?       @map("futures_price") @db.Decimal(10, 4)

  // Status
  bushelsDelivered   Decimal        @default(0) @map("bushels_delivered") @db.Decimal(12, 2)
  isActive           Boolean        @default(true) @map("is_active")

  notes              String?
  deletedAt          DateTime?      @map("deleted_at")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  // Relations
  grainEntity        GrainEntity             @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)
  createdByUser      User                    @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  accumulatorDetails AccumulatorDetails?
  binTransactions    BinTransaction[]
  binAllocations     BinContractAllocation[]

  @@index([grainEntityId, cropYear])
  @@index([contractType, isActive])
  @@index([grainEntityId, year, commodityType])
  @@index([deletedAt])
  @@map("grain_contracts")
}

model AccumulatorDetails {
  id                    String                   @id @default(uuid())
  contractId            String                   @unique @map("contract_id")
  basePrice             Decimal?                 @map("base_price") @db.Decimal(10, 4)
  knockoutPrice         Decimal                  @map("knockout_price") @db.Decimal(10, 4)
  doubleUpPrice         Decimal                  @map("double_up_price") @db.Decimal(10, 4)
  dailyBushels          Decimal                  @map("daily_bushels") @db.Decimal(12, 2)
  totalBushelsMarketed  Decimal                  @default(0) @map("total_bushels_marketed") @db.Decimal(12, 2)
  startDate             DateTime                 @map("start_date")
  endDate               DateTime?                @map("end_date")
  isDailyDouble         Boolean                  @default(false) @map("is_daily_double")
  isCurrentlyDoubled    Boolean                  @default(false) @map("is_currently_doubled")
  knockoutReached       Boolean                  @default(false) @map("knockout_reached")
  knockoutDate          DateTime?                @map("knockout_date")
  basisLocked           Boolean                  @default(false) @map("basis_locked")
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  // Relations
  contract              GrainContract            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  dailyEntries          AccumulatorDailyEntry[]

  @@map("accumulator_details")
}

model AccumulatorDailyEntry {
  id                  String             @id @default(uuid())
  accumulatorId       String             @map("accumulator_id")
  date                DateTime
  bushelsMarketed     Decimal            @map("bushels_marketed") @db.Decimal(12, 2)
  marketPrice         Decimal            @map("market_price") @db.Decimal(10, 4)
  wasDoubledUp        Boolean            @default(false) @map("was_doubled_up")
  notes               String?
  createdAt           DateTime           @default(now()) @map("created_at")

  // Relations
  accumulator         AccumulatorDetails @relation(fields: [accumulatorId], references: [id], onDelete: Cascade)

  @@unique([accumulatorId, date])
  @@index([accumulatorId])
  @@map("accumulator_daily_entries")
}

model BinContractAllocation {
  id              String         @id @default(uuid())
  binId           String         @map("bin_id")
  contractId      String         @map("contract_id")
  bushelsAllocated Decimal       @map("bushels_allocated") @db.Decimal(12, 2)
  pricePerBushel  Decimal        @map("price_per_bushel") @db.Decimal(10, 4) // Lock in the contract price at time of allocation
  notes           String?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  bin             GrainBin       @relation(fields: [binId], references: [id], onDelete: Cascade)
  contract        GrainContract  @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([binId])
  @@index([contractId])
  @@map("bin_contract_allocations")
}

model CropYearProduction {
  id              String        @id @default(uuid())
  grainEntityId   String        @map("grain_entity_id")
  commodityType   CommodityType @map("commodity_type")
  year            Int           // Actual year: 2024, 2025, 2026, etc.
  acres           Decimal       @db.Decimal(12, 2)
  bushelsPerAcre  Decimal       @map("bushels_per_acre") @db.Decimal(10, 2)
  totalProjected  Decimal       @map("total_projected") @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  grainEntity     GrainEntity   @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)

  @@unique([grainEntityId, commodityType, year])
  @@index([grainEntityId, year])
  @@index([commodityType, year])
  @@map("crop_year_productions")
}

model MarketPrice {
  id            String        @id @default(uuid())
  commodityType CommodityType @map("commodity_type")
  price         Decimal       @db.Decimal(10, 4)
  priceDate     DateTime      @map("price_date")
  source        String        // 'USDA_NASS', 'CME', etc.
  marketType    String        @default("SPOT") @map("market_type") // 'SPOT', 'FUTURES'
  contractMonth String?       @map("contract_month")
  createdAt     DateTime      @default(now()) @map("created_at")

  @@index([commodityType, priceDate])
  @@index([priceDate])
  @@map("market_prices")
}

model PriceAlert {
  id              String        @id @default(uuid())
  businessId      String        @map("business_id")
  userId          String        @map("user_id")
  commodityType   CommodityType @map("commodity_type")
  targetPrice     Decimal       @map("target_price") @db.Decimal(10, 4)
  alertType       String        @map("alert_type") // 'ABOVE', 'BELOW'
  isActive        Boolean       @default(true) @map("is_active")
  lastTriggered   DateTime?     @map("last_triggered")
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([businessId, isActive])
  @@index([commodityType, isActive])
  @@map("price_alerts")
}

// ===== Break-Even Calculator Models =====

model Fertilizer {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  name        String   // MAP, DAP, MESZ, POTASH, LIME, UREA, UAN(32%), SULFUR, etc.
  pricePerUnit Decimal @map("price_per_unit") @db.Decimal(10, 2) // Price per lb or gallon
  unit        String   // "LB" or "GAL"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  usage       FarmFertilizerUsage[]

  @@map("fertilizers")
  @@index([businessId])
}

model Chemical {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  name        String
  pricePerUnit Decimal @map("price_per_unit") @db.Decimal(10, 2) // Price per gallon or lb
  unit        String   // "LB" or "GAL"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  usage       FarmChemicalUsage[]

  @@map("chemicals")
  @@index([businessId])
}

model SeedHybrid {
  id          String        @id @default(uuid())
  businessId  String        @map("business_id")
  name        String        // Hybrid name
  commodityType CommodityType @map("commodity_type") // CORN, SOYBEANS, WHEAT
  pricePerBag Decimal       @map("price_per_bag") @db.Decimal(10, 2)
  seedsPerBag Int           @map("seeds_per_bag") // Number of seeds in a bag
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  usage       FarmSeedUsage[]

  @@map("seed_hybrids")
  @@index([businessId])
  @@index([commodityType])
}

model Farm {
  id            String        @id @default(uuid())
  grainEntityId String        @map("grain_entity_id")
  name          String        // "North 40", "South Farm", etc.
  acres         Decimal       @db.Decimal(10, 2)
  commodityType CommodityType @map("commodity_type") // CORN, SOYBEANS, WHEAT
  year          Int           // Crop year
  projectedYield Decimal      @default(0) @map("projected_yield") @db.Decimal(10, 2) // Projected bushels per acre
  aph           Decimal       @default(0) @db.Decimal(10, 2) // Actual Production History (APH)
  notes         String?
  deletedAt     DateTime?     @map("deleted_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  grainEntity   GrainEntity @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)

  // Cost tracking relations
  fertilizerUsage FarmFertilizerUsage[]
  chemicalUsage   FarmChemicalUsage[]
  seedUsage       FarmSeedUsage[]
  otherCosts      FarmOtherCost[]

  @@map("farms")
  @@index([grainEntityId])
  @@index([year])
  @@index([deletedAt])
  @@unique([grainEntityId, name, year])
}

model FarmFertilizerUsage {
  id           String   @id @default(uuid())
  farmId       String   @map("farm_id")
  fertilizerId String   @map("fertilizer_id")
  amountUsed   Decimal  @map("amount_used") @db.Decimal(10, 2) // Total pounds or gallons (calculated from ratePerAcre * acresApplied)
  ratePerAcre  Decimal? @map("rate_per_acre") @db.Decimal(10, 4) // Application rate per acre (e.g., 150 lbs/acre)
  acresApplied Decimal? @map("acres_applied") @db.Decimal(10, 2) // Acres this fertilizer was applied to
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  farm         Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  fertilizer   Fertilizer @relation(fields: [fertilizerId], references: [id], onDelete: Cascade)

  @@map("farm_fertilizer_usage")
  @@index([farmId])
  @@index([fertilizerId])
}

model FarmChemicalUsage {
  id           String   @id @default(uuid())
  farmId       String   @map("farm_id")
  chemicalId   String   @map("chemical_id")
  amountUsed   Decimal  @map("amount_used") @db.Decimal(10, 2) // Total pounds or gallons (calculated from ratePerAcre * acresApplied)
  ratePerAcre  Decimal? @map("rate_per_acre") @db.Decimal(10, 4) // Application rate per acre (e.g., 2.5 gal/acre)
  acresApplied Decimal? @map("acres_applied") @db.Decimal(10, 2) // Acres this chemical was applied to
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  farm         Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  chemical     Chemical @relation(fields: [chemicalId], references: [id], onDelete: Cascade)

  @@map("farm_chemical_usage")
  @@index([farmId])
  @@index([chemicalId])
}

model FarmSeedUsage {
  id             String   @id @default(uuid())
  farmId         String   @map("farm_id")
  seedHybridId   String   @map("seed_hybrid_id")
  bagsUsed       Decimal  @map("bags_used") @db.Decimal(10, 2) // Total bags used (calculated from population * acresApplied / seedsPerBag)
  ratePerAcre    Decimal? @map("rate_per_acre") @db.Decimal(10, 2) // Seeding rate (population - seeds per acre, e.g., 32000)
  acresApplied   Decimal? @map("acres_applied") @db.Decimal(10, 2) // Acres this seed was applied to
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  farm           Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)
  seedHybrid     SeedHybrid @relation(fields: [seedHybridId], references: [id], onDelete: Cascade)

  @@map("farm_seed_usage")
  @@index([farmId])
  @@index([seedHybridId])
}

model FarmOtherCost {
  id          String   @id @default(uuid())
  farmId      String   @map("farm_id")
  costType    String   @map("cost_type") // "LAND_RENT", "INSURANCE", "CUSTOM_WORK", "FUEL", "LABOR", "OTHER"
  amount      Decimal  @db.Decimal(10, 2) // Total amount or per-acre amount
  isPerAcre   Boolean  @default(false) @map("is_per_acre") // If true, multiply by acres
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  farm        Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@map("farm_other_costs")
  @@index([farmId])
  @@index([costType])
}

// ===== Input Bidding System Models =====

model Retailer {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  companyName       String   @map("company_name")
  businessLicense   String?  @map("business_license")
  phone             String?
  address           String?  // Street address for delivery
  city              String?
  state             String?
  zipCode           String?  @map("zip_code")
  latitude          Decimal? @db.Decimal(10, 8)
  longitude         Decimal? @db.Decimal(11, 8)
  radiusPreference  Int      @default(50) @map("radius_preference")
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  bids                RetailerBid[]
  grainPurchaseOffers GrainPurchaseOffer[]
  subscription        RetailerSubscription?

  @@index([latitude, longitude])
  @@index([deletedAt])
  @@map("retailers")
}

model BidRequest {
  id                  String             @id @default(uuid())
  businessId          String             @map("business_id")
  createdBy           String             @map("created_by")
  title               String
  description         String?
  status              BidRequestStatus   @default(OPEN)
  bidDeadline         DateTime?          @map("bid_deadline")
  desiredDeliveryDate DateTime?          @map("desired_delivery_date")
  notes               String?
  deletedAt           DateTime?          @map("deleted_at")
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")
  closedAt            DateTime?          @map("closed_at")

  // Relations
  business            Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator             User               @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  items               BidRequestItem[]
  bids                RetailerBid[]
  sourceInvoice       Invoice[]

  @@map("bid_requests")
  @@index([businessId])
  @@index([status])
  @@index([deletedAt])
}

model BidRequestItem {
  id            String   @id @default(uuid())
  bidRequestId  String   @map("bid_request_id")
  productType   String   @map("product_type")  // "FERTILIZER" or "CHEMICAL"
  productId     String?  @map("product_id")     // Optional FK to Fertilizer or Chemical
  productName   String   @map("product_name")   // Stored for flexibility
  quantity      Decimal  @db.Decimal(10, 2)
  unit          String   // "LB" or "GAL"
  startingPrice Decimal? @map("starting_price") @db.Decimal(10, 2)  // Farmer's original target price (or first retailer bid if left blank) - never changes
  currentPrice  Decimal? @map("current_price") @db.Decimal(10, 2)  // Current best bid price - updates when lower bid received
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  bidRequest    BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)

  @@map("bid_request_items")
  @@index([bidRequestId])
}

enum RetailerBidStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model RetailerBid {
  id                      String             @id @default(uuid())
  bidRequestId            String             @map("bid_request_id")
  retailerId              String             @map("retailer_id")
  status                  RetailerBidStatus  @default(PENDING)
  totalDeliveredPrice     Decimal            @map("total_delivered_price") @db.Decimal(12, 2)
  guaranteedDeliveryDate  DateTime           @map("guaranteed_delivery_date")
  expirationDate          DateTime?          @map("expiration_date")  // Date when bid expires
  termsAcknowledged       Boolean            @default(false) @map("terms_acknowledged")
  notes                   String?
  acceptedAt              DateTime?          @map("accepted_at")  // When farmer accepted
  acceptedBy              String?            @map("accepted_by")  // User ID who accepted
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")

  // Relations
  bidRequest              BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)
  retailer                Retailer   @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  bidItems                RetailerBidItem[]

  @@unique([bidRequestId, retailerId])
  @@map("retailer_bids")
  @@index([retailerId])
  @@index([bidRequestId])
  @@index([status])
}

model RetailerBidItem {
  id                String      @id @default(uuid())
  retailerBidId     String      @map("retailer_bid_id")
  bidRequestItemId  String      @map("bid_request_item_id")
  pricePerUnit      Decimal     @map("price_per_unit") @db.Decimal(10, 2)
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relations
  retailerBid       RetailerBid @relation(fields: [retailerBidId], references: [id], onDelete: Cascade)

  @@map("retailer_bid_items")
  @@index([retailerBidId])
  @@index([bidRequestItemId])
}

// ===== Invoice Parsing System Models =====

enum InvoiceStatus {
  PENDING    // Upload complete, parsing in progress
  PARSED     // Successfully parsed
  FAILED     // Parsing failed
  REVIEWED   // User reviewed and locked prices
}

enum InvoiceProductType {
  FERTILIZER
  CHEMICAL
  SEED
}

model Invoice {
  id                  String          @id @default(uuid())
  businessId          String          @map("business_id")
  uploadedBy          String          @map("uploaded_by")
  fileName            String          @map("file_name")
  filePath            String          @map("file_path")
  fileSize            Int             @map("file_size")
  mimeType            String          @map("mime_type")
  status              InvoiceStatus   @default(PENDING)

  vendorName          String?         @map("vendor_name")
  invoiceNumber       String?         @map("invoice_number")
  invoiceDate         DateTime?       @map("invoice_date")
  totalAmount         Decimal?        @map("total_amount") @db.Decimal(12, 2)

  parsedData          Json?           @map("parsed_data")
  parseError          String?         @map("parse_error")
  parsedAt            DateTime?       @map("parsed_at")

  createdBidRequestId String?         @map("created_bid_request_id")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  // Relations
  business            Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  uploader            User            @relation("InvoiceUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  lineItems           InvoiceLineItem[]
  createdBidRequest   BidRequest?     @relation(fields: [createdBidRequestId], references: [id], onDelete: SetNull)

  @@map("invoices")
  @@index([businessId, status])
  @@index([uploadedBy])
}

model InvoiceLineItem {
  id                  String               @id @default(uuid())
  invoiceId           String               @map("invoice_id")
  productType         InvoiceProductType   @map("product_type")
  productName         String               @map("product_name")
  quantity            Decimal              @db.Decimal(10, 2)
  unit                String
  pricePerUnit        Decimal              @map("price_per_unit") @db.Decimal(10, 2)
  totalPrice          Decimal              @map("total_price") @db.Decimal(12, 2)
  ratePerAcre         Decimal?             @map("rate_per_acre") @db.Decimal(10, 4)
  rateUnit            String?              @map("rate_unit")

  matchedProductId    String?              @map("matched_product_id")
  matchedProductType  InvoiceProductType?  @map("matched_product_type")
  isNewProduct        Boolean              @default(false) @map("is_new_product")

  priceLockedAt       DateTime?            @map("price_locked_at")
  priceLockedBy       String?              @map("price_locked_by")

  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")

  // Relations
  invoice             Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  purchaseHistory     PurchaseHistory?

  @@map("invoice_line_items")
  @@index([invoiceId])
  @@index([productType])
}

model PurchaseHistory {
  id                  String               @id @default(uuid())
  businessId          String               @map("business_id")
  invoiceLineItemId   String               @unique @map("invoice_line_item_id")

  productType         InvoiceProductType   @map("product_type")
  productId           String?              @map("product_id")
  productName         String               @map("product_name")

  purchasedQuantity   Decimal              @map("purchased_quantity") @db.Decimal(10, 2)
  purchasedUnit       String               @map("purchased_unit")
  purchasedPrice      Decimal              @map("purchased_price") @db.Decimal(10, 2)
  totalCost           Decimal              @map("total_cost") @db.Decimal(12, 2)

  purchasedAt         DateTime             @map("purchased_at")
  vendorName          String?              @map("vendor_name")

  createdAt           DateTime             @default(now()) @map("created_at")

  // Relations
  business            Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoiceLineItem     InvoiceLineItem      @relation(fields: [invoiceLineItemId], references: [id], onDelete: Cascade)

  @@map("purchase_history")
  @@index([businessId, productType])
  @@index([productId])
  @@index([purchasedAt])
}

// ===== Grain Bin Storage Tracker Models =====

model GrainBin {
  id                  String        @id @default(uuid())
  grainEntityId       String        @map("grain_entity_id")
  name                String        // "North Bin", "West Storage"
  capacity            Decimal       @db.Decimal(12, 2)
  currentBushels      Decimal       @default(0) @map("current_bushels") @db.Decimal(12, 2)
  contractedBushels   Decimal       @default(0) @map("contracted_bushels") @db.Decimal(12, 2) // Bushels allocated to contracts
  commodityType       CommodityType @map("commodity_type")
  cropYear            Int           @map("crop_year") // 2023, 2024, 2025
  isAvailableForSale  Boolean       @default(false) @map("is_available_for_sale") // Show in marketplace
  targetPrice         Decimal?      @map("target_price") @db.Decimal(10, 4) // Target cash price per bushel
  notes               String?
  isActive            Boolean       @default(true) @map("is_active")
  deletedAt           DateTime?     @map("deleted_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  grainEntity         GrainEntity             @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)
  scaleTickets        ScaleTicket[]
  binTransactions     BinTransaction[]
  purchaseOffers      GrainPurchaseOffer[]
  contractAllocations BinContractAllocation[]

  @@index([grainEntityId, commodityType])
  @@index([cropYear])
  @@index([deletedAt])
  @@index([isAvailableForSale])
  @@map("grain_bins")
}

model ScaleTicket {
  id              String             @id @default(uuid())
  businessId      String             @map("business_id")
  uploadedBy      String             @map("uploaded_by")
  binId           String?            @map("bin_id")
  fileName        String             @map("file_name")
  filePath        String             @map("file_path")
  fileSize        Int                @map("file_size")
  mimeType        String             @map("mime_type")
  status          ScaleTicketStatus  @default(PENDING)

  // Parsed data
  loadNumber      String?            @map("load_number")
  ticketDate      DateTime?          @map("ticket_date")
  netBushels      Decimal?           @map("net_bushels") @db.Decimal(12, 2)
  moisture        Decimal?           @db.Decimal(5, 2)
  testWeight      Decimal?           @map("test_weight") @db.Decimal(5, 2)
  commodityType   CommodityType?     @map("commodity_type")
  buyer           String?

  parsedData      Json?              @map("parsed_data")
  parseError      String?            @map("parse_error")
  parsedAt        DateTime?          @map("parsed_at")
  processedAt     DateTime?          @map("processed_at")

  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  business        Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  uploader        User               @relation("ScaleTicketUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  bin             GrainBin?          @relation(fields: [binId], references: [id], onDelete: SetNull)
  binTransaction  BinTransaction?

  @@map("scale_tickets")
  @@index([businessId, status])
  @@index([binId])
}

model BinTransaction {
  id              String              @id @default(uuid())
  binId           String              @map("bin_id")
  type            String              // "ADDITION", "REMOVAL", "SALE", "ADJUSTMENT"
  bushels         Decimal             @db.Decimal(12, 2)
  description     String?
  scaleTicketId   String?             @unique @map("scale_ticket_id")
  grainContractId String?             @map("grain_contract_id")
  createdBy       String              @map("created_by")
  transactionDate DateTime            @default(now()) @map("transaction_date")
  createdAt       DateTime            @default(now()) @map("created_at")

  // Relations
  bin             GrainBin            @relation(fields: [binId], references: [id], onDelete: Cascade)
  scaleTicket     ScaleTicket?        @relation(fields: [scaleTicketId], references: [id], onDelete: SetNull)
  grainContract   GrainContract?      @relation(fields: [grainContractId], references: [id], onDelete: SetNull)
  user            User                @relation("BinTransactionCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("bin_transactions")
  @@index([binId])
  @@index([transactionDate])
}

// ===== Grain Marketplace Models =====

model GrainPurchaseOffer {
  id                      String                    @id @default(uuid())
  retailerId              String                    @map("retailer_id")
  grainBinId              String                    @map("grain_bin_id")
  bushelsOffered          Decimal                   @map("bushels_offered") @db.Decimal(12, 2)
  pricePerBushel          Decimal                   @map("price_per_bushel") @db.Decimal(10, 4)
  totalOfferPrice         Decimal                   @map("total_offer_price") @db.Decimal(12, 2)
  status                  GrainPurchaseOfferStatus  @default(PENDING)
  expirationDate          DateTime?                 @map("expiration_date")
  pickupDate              DateTime?                 @map("pickup_date")
  notes                   String?
  acceptedAt              DateTime?                 @map("accepted_at")
  acceptedBy              String?                   @map("accepted_by")
  rejectedAt              DateTime?                 @map("rejected_at")
  createdAt               DateTime                  @default(now()) @map("created_at")
  updatedAt               DateTime                  @updatedAt @map("updated_at")

  // Relations
  retailer                Retailer                  @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  grainBin                GrainBin                  @relation(fields: [grainBinId], references: [id], onDelete: Cascade)

  @@map("grain_purchase_offers")
  @@index([retailerId])
  @@index([grainBinId])
  @@index([status])
}

// ===== Subscription & Billing Models =====

model SubscriptionPlan {
  id              String   @id @default(uuid())
  name            String   // "Free", "Premium"
  entityType      String   // "BUSINESS", "RETAILER"
  stripePriceId   String?  @unique @map("stripe_price_id")
  price           Decimal  @db.Decimal(10, 2)
  interval        String   // "month", "year"
  maxContracts    Int?     @map("max_contracts")
  maxBins         Int?     @map("max_bins")
  maxBidsPerMonth Int?     @map("max_bids_per_month")
  maxFarms        Int?     @map("max_farms")
  features        Json
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  businessSubscriptions BusinessSubscription[]
  retailerSubscriptions RetailerSubscription[]

  @@map("subscription_plans")
}

model BusinessSubscription {
  id                    String    @id @default(uuid())
  businessId            String    @unique @map("business_id")
  planId                String    @map("plan_id")
  stripeCustomerId      String    @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?   @unique @map("stripe_subscription_id")
  status                String    // "active", "trialing", "past_due", "canceled"
  currentPeriodStart    DateTime? @map("current_period_start")
  currentPeriodEnd      DateTime? @map("current_period_end")
  cancelAtPeriodEnd     Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt            DateTime? @map("canceled_at")
  trialStart            DateTime? @map("trial_start")
  trialEnd              DateTime? @map("trial_end")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  business              Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])
  paymentHistory        PaymentHistory[]

  @@index([businessId])
  @@index([status])
  @@map("business_subscriptions")
}

model RetailerSubscription {
  id                    String    @id @default(uuid())
  retailerId            String    @unique @map("retailer_id")
  planId                String    @map("plan_id")
  stripeCustomerId      String    @unique @map("stripe_customer_id")
  stripeSubscriptionId  String?   @unique @map("stripe_subscription_id")
  status                String
  currentPeriodStart    DateTime? @map("current_period_start")
  currentPeriodEnd      DateTime? @map("current_period_end")
  cancelAtPeriodEnd     Boolean   @default(false) @map("cancel_at_period_end")
  canceledAt            DateTime? @map("canceled_at")
  trialStart            DateTime? @map("trial_start")
  trialEnd              DateTime? @map("trial_end")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  retailer              Retailer  @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])
  paymentHistory        PaymentHistory[]

  @@index([retailerId])
  @@index([status])
  @@map("retailer_subscriptions")
}

model PaymentHistory {
  id                      String    @id @default(uuid())
  businessSubscriptionId  String?   @map("business_subscription_id")
  retailerSubscriptionId  String?   @map("retailer_subscription_id")
  stripeInvoiceId         String    @unique @map("stripe_invoice_id")
  stripePaymentIntentId   String?   @map("stripe_payment_intent_id")
  amount                  Decimal   @db.Decimal(10, 2)
  currency                String    @default("usd")
  status                  String    // "paid", "failed", "pending"
  invoiceUrl              String?   @map("invoice_url")
  invoicePdf              String?   @map("invoice_pdf")
  paidAt                  DateTime? @map("paid_at")
  createdAt               DateTime  @default(now()) @map("created_at")

  // Relations
  businessSubscription    BusinessSubscription? @relation(fields: [businessSubscriptionId], references: [id], onDelete: Cascade)
  retailerSubscription    RetailerSubscription? @relation(fields: [retailerSubscriptionId], references: [id], onDelete: Cascade)

  @@index([businessSubscriptionId])
  @@index([retailerSubscriptionId])
  @@map("payment_history")
}

// ===== Marketing AI Models =====

enum MarketingSignalType {
  CASH_SALE
  BASIS_CONTRACT
  HTA_RECOMMENDATION
  ACCUMULATOR_STRATEGY
  ACCUMULATOR_INQUIRY
  PUT_OPTION
  CALL_OPTION
  COLLAR_STRATEGY
}

enum SignalStrength {
  STRONG_BUY
  BUY
  HOLD
  SELL
  STRONG_SELL
}

enum SignalStatus {
  ACTIVE
  TRIGGERED
  EXPIRED
  DISMISSED
}

enum NotificationChannel {
  PUSH
  EMAIL
  IN_APP
}

enum RiskTolerance {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

model MarketingPreferences {
  id                      String        @id @default(uuid())
  businessId              String        @unique @map("business_id")

  // Notification preferences
  enablePushNotifications   Boolean     @default(true) @map("enable_push_notifications")
  enableEmailNotifications  Boolean     @default(true) @map("enable_email_notifications")
  enableInAppNotifications  Boolean     @default(true) @map("enable_in_app_notifications")
  quietHoursStart           String?     @map("quiet_hours_start") // "22:00"
  quietHoursEnd             String?     @map("quiet_hours_end")   // "06:00"

  // Signal preferences by commodity
  cornEnabled             Boolean       @default(true) @map("corn_enabled")
  soybeansEnabled         Boolean       @default(true) @map("soybeans_enabled")
  wheatEnabled            Boolean       @default(true) @map("wheat_enabled")

  // Marketing tool preferences
  cashSaleSignals         Boolean       @default(true) @map("cash_sale_signals")
  basisContractSignals    Boolean       @default(true) @map("basis_contract_signals")
  htaSignals              Boolean       @default(true) @map("hta_signals")
  accumulatorSignals      Boolean       @default(true) @map("accumulator_signals")
  accumulatorInquirySignals Boolean     @default(true) @map("accumulator_inquiry_signals")
  optionsSignals          Boolean       @default(false) @map("options_signals")

  // Risk tolerance affects signal thresholds
  riskTolerance           RiskTolerance @default(MODERATE) @map("risk_tolerance")

  // Target profit margin above break-even (dollars/bushel)
  targetProfitMargin      Decimal       @default(0.50) @map("target_profit_margin") @db.Decimal(10, 4)

  // Minimum percentage above break-even to trigger sell signal
  minAboveBreakeven       Decimal       @default(0.05) @map("min_above_breakeven") @db.Decimal(5, 4) // 5%

  // Accumulator inquiry thresholds
  accumulatorMinPrice     Decimal?      @map("accumulator_min_price") @db.Decimal(10, 4) // Min price to check accumulators
  accumulatorPercentAboveBreakeven Decimal? @default(0.10) @map("accumulator_percent_above_breakeven") @db.Decimal(5, 4) // 10%
  accumulatorMarketingPercent Decimal?  @default(0.20) @map("accumulator_marketing_percent") @db.Decimal(5, 4) // 20%

  // Pre-harvest marketing targets (% of crop to market before harvest)
  // Farmers can set how aggressively they want to forward sell new crop
  preHarvestTargetCorn      Decimal?    @default(0.50) @map("pre_harvest_target_corn") @db.Decimal(5, 4) // 50% default
  preHarvestTargetSoybeans  Decimal?    @default(0.50) @map("pre_harvest_target_soybeans") @db.Decimal(5, 4) // 50% default
  preHarvestTargetWheat     Decimal?    @default(0.50) @map("pre_harvest_target_wheat") @db.Decimal(5, 4) // 50% default

  // Maximum single sale recommendation (% of remaining bushels per signal)
  maxSingleSalePercent      Decimal?    @default(0.25) @map("max_single_sale_percent") @db.Decimal(5, 4) // 25% default

  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")

  // Relations
  business                Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("marketing_preferences")
}

model MarketingSignal {
  id                    String              @id @default(uuid())
  businessId            String              @map("business_id")
  grainEntityId         String?             @map("grain_entity_id")

  signalType            MarketingSignalType @map("signal_type")
  commodityType         CommodityType       @map("commodity_type")
  strength              SignalStrength
  status                SignalStatus        @default(ACTIVE)

  // Crop year context (e.g., "2025" for old crop, "2026" for new crop)
  cropYear              Int?                @map("crop_year")
  isNewCrop             Boolean             @default(false) @map("is_new_crop")

  // Price context
  currentPrice          Decimal             @map("current_price") @db.Decimal(10, 4)
  breakEvenPrice        Decimal             @map("break_even_price") @db.Decimal(10, 4)
  targetPrice           Decimal?            @map("target_price") @db.Decimal(10, 4)
  priceAboveBreakeven   Decimal             @map("price_above_breakeven") @db.Decimal(10, 4)
  percentAboveBreakeven Decimal             @map("percent_above_breakeven") @db.Decimal(5, 4)

  // Signal details
  title                 String
  summary               String
  rationale             String?             // Rule-based explanation
  aiAnalysis            String?             @map("ai_analysis") // AI-generated deeper analysis
  aiAnalyzedAt          DateTime?           @map("ai_analyzed_at")

  // Market context (JSON blob for flexibility)
  marketContext         Json?               @map("market_context")

  // Recommendation details
  recommendedBushels    Decimal?            @map("recommended_bushels") @db.Decimal(12, 2)
  recommendedAction     String?             @map("recommended_action")
  expiresAt             DateTime?           @map("expires_at")

  // Tracking
  viewedAt              DateTime?           @map("viewed_at")
  actionTaken           String?             @map("action_taken")
  actionTakenAt         DateTime?           @map("action_taken_at")
  dismissedAt           DateTime?           @map("dismissed_at")
  dismissReason         String?             @map("dismiss_reason")

  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  // Relations
  notifications         SignalNotification[]
  interactions          SignalInteraction[]
  triggeredDecisions    MarketingDecision[]

  @@index([businessId, status])
  @@index([commodityType, status])
  @@index([signalType, status])
  @@index([createdAt])
  @@map("marketing_signals")
}

model SignalNotification {
  id              String              @id @default(uuid())
  signalId        String              @map("signal_id")
  userId          String              @map("user_id")
  channel         NotificationChannel
  sentAt          DateTime?           @map("sent_at")
  deliveredAt     DateTime?           @map("delivered_at")
  readAt          DateTime?           @map("read_at")
  failedAt        DateTime?           @map("failed_at")
  errorMessage    String?             @map("error_message")
  createdAt       DateTime            @default(now()) @map("created_at")

  // Relations
  signal          MarketingSignal     @relation(fields: [signalId], references: [id], onDelete: Cascade)

  @@unique([signalId, userId, channel])
  @@index([userId])
  @@map("signal_notifications")
}

model FuturesQuote {
  id              String        @id @default(uuid())
  commodityType   CommodityType @map("commodity_type")
  contractMonth   String        @map("contract_month") // "MAR25", "MAY25", etc.
  contractYear    Int           @map("contract_year")
  openPrice       Decimal?      @map("open_price") @db.Decimal(10, 4)
  highPrice       Decimal?      @map("high_price") @db.Decimal(10, 4)
  lowPrice        Decimal?      @map("low_price") @db.Decimal(10, 4)
  closePrice      Decimal       @map("close_price") @db.Decimal(10, 4)
  settlementPrice Decimal?      @map("settlement_price") @db.Decimal(10, 4)
  volume          Int?
  openInterest    Int?          @map("open_interest")
  priceChange     Decimal?      @map("price_change") @db.Decimal(10, 4)
  quoteDate       DateTime      @map("quote_date")
  source          String        // "CME", "BARCHART"
  createdAt       DateTime      @default(now()) @map("created_at")

  @@unique([commodityType, contractMonth, contractYear, quoteDate])
  @@index([commodityType, contractMonth])
  @@index([quoteDate])
  @@map("futures_quotes")
}

model BasisData {
  id              String        @id @default(uuid())
  commodityType   CommodityType @map("commodity_type")
  location        String        // Elevator/location name
  latitude        Decimal?      @db.Decimal(10, 8)
  longitude       Decimal?      @db.Decimal(11, 8)
  cashPrice       Decimal       @map("cash_price") @db.Decimal(10, 4)
  futuresMonth    String        @map("futures_month")
  futuresPrice    Decimal       @map("futures_price") @db.Decimal(10, 4)
  basis           Decimal       @db.Decimal(10, 4)
  priceDate       DateTime      @map("price_date")
  source          String
  createdAt       DateTime      @default(now()) @map("created_at")

  @@index([commodityType, location])
  @@index([priceDate])
  @@map("basis_data")
}

model OptionsPosition {
  id                String        @id @default(uuid())
  businessId        String        @map("business_id")
  grainEntityId     String?       @map("grain_entity_id")
  commodityType     CommodityType @map("commodity_type")

  optionType        String        @map("option_type") // "PUT", "CALL"
  strikePrice       Decimal       @map("strike_price") @db.Decimal(10, 4)
  futuresMonth      String        @map("futures_month")
  expirationDate    DateTime      @map("expiration_date")

  contracts         Int           // Number of options contracts
  bushelsPerContract Int          @default(5000) @map("bushels_per_contract")
  premium           Decimal       @db.Decimal(10, 4)
  totalCost         Decimal       @map("total_cost") @db.Decimal(12, 2)

  currentValue      Decimal?      @map("current_value") @db.Decimal(12, 2)
  lastPriceUpdate   DateTime?     @map("last_price_update")

  isOpen            Boolean       @default(true) @map("is_open")
  closedAt          DateTime?     @map("closed_at")
  closedPrice       Decimal?      @map("closed_price") @db.Decimal(10, 4)

  notes             String?
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  @@index([businessId, isOpen])
  @@index([commodityType, futuresMonth])
  @@map("options_positions")
}

model AIAnalysisLog {
  id              String    @id @default(uuid())
  businessId      String    @map("business_id")
  analysisType    String    @map("analysis_type") // "SIGNAL_EXPLANATION", "STRATEGY_RECOMMENDATION", "MARKET_OUTLOOK"
  prompt          String
  response        String
  modelUsed       String    @map("model_used") // "claude-3-opus", "gpt-4", etc.
  tokensUsed      Int       @map("tokens_used")
  latencyMs       Int       @map("latency_ms")
  successful      Boolean
  errorMessage    String?   @map("error_message")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([businessId])
  @@index([analysisType])
  @@index([createdAt])
  @@map("ai_analysis_logs")
}

// ===== User Marketing Learning Models =====

// Stores learned preferences and behavior patterns per user
model UserMarketingProfile {
  id                      String        @id @default(uuid())
  userId                  String        @unique @map("user_id")

  // Learned risk profile (adjusts over time based on behavior)
  learnedRiskScore        Decimal       @default(50) @map("learned_risk_score") @db.Decimal(5, 2) // 0-100, higher = more aggressive

  // Price action patterns
  avgSellPriceAboveBE     Decimal?      @map("avg_sell_price_above_be") @db.Decimal(10, 4) // Average % above BE when they sell
  preferredSellWindow     String?       @map("preferred_sell_window") // "EARLY", "MID", "LATE" season
  actOnStrongSignalsRate  Decimal       @default(0) @map("act_on_strong_signals_rate") @db.Decimal(5, 4) // % of STRONG_BUY signals acted on
  actOnRegularSignalsRate Decimal       @default(0) @map("act_on_regular_signals_rate") @db.Decimal(5, 4) // % of BUY signals acted on
  avgResponseTimeHours    Decimal?      @map("avg_response_time_hours") @db.Decimal(10, 2) // How quickly they act on signals

  // Commodity preferences (learned from behavior)
  cornPreferenceScore     Decimal       @default(50) @map("corn_preference_score") @db.Decimal(5, 2)
  soybeansPreferenceScore Decimal       @default(50) @map("soybeans_preference_score") @db.Decimal(5, 2)
  wheatPreferenceScore    Decimal       @default(50) @map("wheat_preference_score") @db.Decimal(5, 2)

  // Marketing tool preferences (learned from which tools they use)
  cashSalePreference      Decimal       @default(50) @map("cash_sale_preference") @db.Decimal(5, 2)
  basisContractPreference Decimal       @default(50) @map("basis_contract_preference") @db.Decimal(5, 2)
  htaPreference           Decimal       @default(50) @map("hta_preference") @db.Decimal(5, 2)
  accumulatorPreference   Decimal       @default(50) @map("accumulator_preference") @db.Decimal(5, 2)
  optionsPreference       Decimal       @default(50) @map("options_preference") @db.Decimal(5, 2)

  // Statistics
  totalSignalsReceived    Int           @default(0) @map("total_signals_received")
  totalSignalsActedOn     Int           @default(0) @map("total_signals_acted_on")
  totalSignalsDismissed   Int           @default(0) @map("total_signals_dismissed")
  totalBushelsSold        Decimal       @default(0) @map("total_bushels_sold") @db.Decimal(15, 2)
  totalRevenue            Decimal       @default(0) @map("total_revenue") @db.Decimal(15, 2)

  // Model metadata
  lastUpdated             DateTime      @default(now()) @map("last_updated")
  modelVersion            Int           @default(1) @map("model_version")
  confidenceScore         Decimal       @default(0) @map("confidence_score") @db.Decimal(5, 2) // How confident the model is (based on data points)

  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")

  // Relations
  user                    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  decisions               MarketingDecision[]
  interactions            SignalInteraction[]
  learnedThresholds       LearnedThreshold[]

  @@index([userId])
  @@index([learnedRiskScore])
  @@map("user_marketing_profiles")
}

// Logs actual marketing decisions made by the user
model MarketingDecision {
  id                  String              @id @default(uuid())
  profileId           String              @map("profile_id")
  businessId          String              @map("business_id")

  // What was sold
  commodityType       CommodityType       @map("commodity_type")
  contractType        ContractType        @map("contract_type")
  bushels             Decimal             @map("bushels") @db.Decimal(12, 2)
  pricePerBushel      Decimal             @map("price_per_bushel") @db.Decimal(10, 4)
  totalValue          Decimal             @map("total_value") @db.Decimal(15, 2)

  // Context at time of decision
  breakEvenPrice      Decimal             @map("break_even_price") @db.Decimal(10, 4)
  percentAboveBE      Decimal             @map("percent_above_be") @db.Decimal(5, 4)
  futuresPrice        Decimal             @map("futures_price") @db.Decimal(10, 4)
  basisAtSale         Decimal             @map("basis_at_sale") @db.Decimal(10, 4)

  // Was this triggered by a signal?
  triggeredBySignalId String?             @map("triggered_by_signal_id")

  // Market conditions at time of sale
  rsiAtSale           Decimal?            @map("rsi_at_sale") @db.Decimal(5, 2)
  trendAtSale         String?             @map("trend_at_sale") // "UP", "DOWN", "NEUTRAL"
  volatilityAtSale    Decimal?            @map("volatility_at_sale") @db.Decimal(5, 4)

  // Outcome tracking (filled in later when we know how price moved)
  priceOneWeekLater   Decimal?            @map("price_one_week_later") @db.Decimal(10, 4)
  priceTwoWeeksLater  Decimal?            @map("price_two_weeks_later") @db.Decimal(10, 4)
  priceOneMonthLater  Decimal?            @map("price_one_month_later") @db.Decimal(10, 4)
  decisionQuality     String?             @map("decision_quality") // "EXCELLENT", "GOOD", "NEUTRAL", "POOR" - calculated retroactively

  decisionDate        DateTime            @default(now()) @map("decision_date")
  createdAt           DateTime            @default(now()) @map("created_at")

  // Relations
  profile             UserMarketingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  signal              MarketingSignal?    @relation(fields: [triggeredBySignalId], references: [id])

  @@index([profileId])
  @@index([businessId])
  @@index([commodityType])
  @@index([decisionDate])
  @@map("marketing_decisions")
}

// Tracks every interaction with a signal for learning
model SignalInteraction {
  id                  String              @id @default(uuid())
  profileId           String              @map("profile_id")
  signalId            String              @map("signal_id")

  // Interaction type
  interactionType     String              @map("interaction_type") // "VIEWED", "DISMISSED", "ACTED", "IGNORED"

  // Timing
  signalCreatedAt     DateTime            @map("signal_created_at")
  interactionAt       DateTime            @default(now()) @map("interaction_at")
  responseTimeMinutes Int?                @map("response_time_minutes")

  // Signal context at interaction
  signalType          MarketingSignalType @map("signal_type")
  signalStrength      SignalStrength      @map("signal_strength")
  commodityType       CommodityType       @map("commodity_type")
  priceAtSignal       Decimal             @map("price_at_signal") @db.Decimal(10, 4)
  percentAboveBE      Decimal             @map("percent_above_be") @db.Decimal(5, 4)

  // If dismissed, why?
  dismissReason       String?             @map("dismiss_reason")

  // If acted, what action?
  actionTaken         String?             @map("action_taken")
  bushelsMarketed     Decimal?            @map("bushels_marketed") @db.Decimal(12, 2)

  createdAt           DateTime            @default(now()) @map("created_at")

  // Relations
  profile             UserMarketingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  signal              MarketingSignal     @relation(fields: [signalId], references: [id], onDelete: Cascade)

  @@unique([profileId, signalId])
  @@index([profileId])
  @@index([signalId])
  @@index([interactionType])
  @@index([signalStrength])
  @@map("signal_interactions")
}

// Stores personalized thresholds learned over time
model LearnedThreshold {
  id                  String              @id @default(uuid())
  profileId           String              @map("profile_id")

  // What this threshold applies to
  commodityType       CommodityType       @map("commodity_type")
  signalType          MarketingSignalType @map("signal_type")

  // Learned thresholds (personalized for this user)
  strongBuyThreshold  Decimal             @map("strong_buy_threshold") @db.Decimal(5, 4) // % above BE for STRONG_BUY
  buyThreshold        Decimal             @map("buy_threshold") @db.Decimal(5, 4) // % above BE for BUY

  // How this differs from default
  thresholdAdjustment Decimal             @default(0) @map("threshold_adjustment") @db.Decimal(5, 4) // +/- adjustment from defaults

  // Confidence in this learned threshold
  dataPoints          Int                 @default(0) @map("data_points") // How many decisions informed this
  confidenceScore     Decimal             @default(0) @map("confidence_score") @db.Decimal(5, 2)

  lastUpdated         DateTime            @default(now()) @map("last_updated")
  createdAt           DateTime            @default(now()) @map("created_at")

  // Relations
  profile             UserMarketingProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, commodityType, signalType])
  @@index([profileId])
  @@map("learned_thresholds")
}

// ===== Fundamental Market Data Models =====

// USDA WASDE (World Agricultural Supply and Demand Estimates) Data
model SupplyDemandData {
  id                  String        @id @default(uuid())
  commodityType       CommodityType @map("commodity_type")
  marketingYear       String        @map("marketing_year") // "2024/25"
  reportDate          DateTime      @map("report_date")

  // US Supply (Million Bushels)
  beginningStocks     Decimal?      @map("beginning_stocks") @db.Decimal(12, 2)
  production          Decimal?      @db.Decimal(12, 2)
  imports             Decimal?      @db.Decimal(12, 2)
  totalSupply         Decimal?      @map("total_supply") @db.Decimal(12, 2)

  // US Demand (Million Bushels)
  feedAndResidue      Decimal?      @map("feed_and_residue") @db.Decimal(12, 2)
  foodSeedIndustrial  Decimal?      @map("food_seed_industrial") @db.Decimal(12, 2)
  ethanolUse          Decimal?      @map("ethanol_use") @db.Decimal(12, 2) // Corn specific
  exports             Decimal?      @db.Decimal(12, 2)
  totalDemand         Decimal?      @map("total_demand") @db.Decimal(12, 2)

  // Carryout / Ending Stocks
  endingStocks        Decimal?      @map("ending_stocks") @db.Decimal(12, 2)
  stocksToUseRatio    Decimal?      @map("stocks_to_use_ratio") @db.Decimal(5, 4) // Key ratio for price direction

  // Prices
  avgFarmPrice        Decimal?      @map("avg_farm_price") @db.Decimal(10, 4)
  avgFarmPriceLow     Decimal?      @map("avg_farm_price_low") @db.Decimal(10, 4)
  avgFarmPriceHigh    Decimal?      @map("avg_farm_price_high") @db.Decimal(10, 4)

  // World Data
  worldProduction     Decimal?      @map("world_production") @db.Decimal(15, 2)
  worldEndingStocks   Decimal?      @map("world_ending_stocks") @db.Decimal(15, 2)
  worldStocksToUse    Decimal?      @map("world_stocks_to_use") @db.Decimal(5, 4)

  // Change from previous report
  endingStocksChange  Decimal?      @map("ending_stocks_change") @db.Decimal(12, 2)
  productionChange    Decimal?      @map("production_change") @db.Decimal(12, 2)

  source              String        @default("USDA_WASDE")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@unique([commodityType, marketingYear, reportDate])
  @@index([commodityType, marketingYear])
  @@index([reportDate])
  @@map("supply_demand_data")
}

// USDA Crop Progress and Condition Data
model CropProgressData {
  id                  String        @id @default(uuid())
  commodityType       CommodityType @map("commodity_type")
  year                Int
  weekEnding          DateTime      @map("week_ending")
  state               String?       // NULL for national, or state abbreviation

  // Planting Progress (% complete)
  plantedPct          Decimal?      @map("planted_pct") @db.Decimal(5, 2)
  plantedPctPrevYear  Decimal?      @map("planted_pct_prev_year") @db.Decimal(5, 2)
  plantedPctAvg5Yr    Decimal?      @map("planted_pct_avg_5yr") @db.Decimal(5, 2)

  // Emergence Progress
  emergedPct          Decimal?      @map("emerged_pct") @db.Decimal(5, 2)
  emergedPctPrevYear  Decimal?      @map("emerged_pct_prev_year") @db.Decimal(5, 2)
  emergedPctAvg5Yr    Decimal?      @map("emerged_pct_avg_5yr") @db.Decimal(5, 2)

  // Crop Conditions (% of crop)
  conditionExcellent  Decimal?      @map("condition_excellent") @db.Decimal(5, 2)
  conditionGood       Decimal?      @map("condition_good") @db.Decimal(5, 2)
  conditionFair       Decimal?      @map("condition_fair") @db.Decimal(5, 2)
  conditionPoor       Decimal?      @map("condition_poor") @db.Decimal(5, 2)
  conditionVeryPoor   Decimal?      @map("condition_very_poor") @db.Decimal(5, 2)
  goodExcellentPct    Decimal?      @map("good_excellent_pct") @db.Decimal(5, 2) // Key metric: Good + Excellent

  // Harvest Progress
  harvestedPct        Decimal?      @map("harvested_pct") @db.Decimal(5, 2)
  harvestedPctPrevYear Decimal?     @map("harvested_pct_prev_year") @db.Decimal(5, 2)
  harvestedPctAvg5Yr  Decimal?      @map("harvested_pct_avg_5yr") @db.Decimal(5, 2)

  // Silking/Podding stages (corn/soybeans)
  silkingPct          Decimal?      @map("silking_pct") @db.Decimal(5, 2) // Corn
  settingPodsPct      Decimal?      @map("setting_pods_pct") @db.Decimal(5, 2) // Soybeans
  droppingLeavesPct   Decimal?      @map("dropping_leaves_pct") @db.Decimal(5, 2) // Soybeans

  source              String        @default("USDA_NASS")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@unique([commodityType, year, weekEnding, state])
  @@index([commodityType, year])
  @@index([weekEnding])
  @@map("crop_progress_data")
}

// Weekly Export Sales Data
model ExportSalesData {
  id                  String        @id @default(uuid())
  commodityType       CommodityType @map("commodity_type")
  marketingYear       String        @map("marketing_year") // "2024/25"
  weekEnding          DateTime      @map("week_ending")

  // Weekly Sales (Thousand Metric Tons)
  weeklySales         Decimal?      @map("weekly_sales") @db.Decimal(12, 2)
  weeklyExports       Decimal?      @map("weekly_exports") @db.Decimal(12, 2)

  // Cumulative (MY to date)
  cumulativeSales     Decimal?      @map("cumulative_sales") @db.Decimal(12, 2)
  cumulativeExports   Decimal?      @map("cumulative_exports") @db.Decimal(12, 2)

  // Outstanding Sales
  outstandingSales    Decimal?      @map("outstanding_sales") @db.Decimal(12, 2)

  // Year-over-year comparison
  salesVsPrevYear     Decimal?      @map("sales_vs_prev_year") @db.Decimal(5, 4) // % change
  paceVsUSDA          Decimal?      @map("pace_vs_usda") @db.Decimal(5, 4) // % of USDA projection

  // Key destinations
  topBuyer1           String?       @map("top_buyer_1") // "China", "Mexico", etc.
  topBuyer1Volume     Decimal?      @map("top_buyer_1_volume") @db.Decimal(12, 2)
  topBuyer2           String?       @map("top_buyer_2")
  topBuyer2Volume     Decimal?      @map("top_buyer_2_volume") @db.Decimal(12, 2)

  source              String        @default("USDA_FAS")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@unique([commodityType, marketingYear, weekEnding])
  @@index([commodityType, marketingYear])
  @@index([weekEnding])
  @@map("export_sales_data")
}

// Yield Forecasts and Estimates
model YieldForecast {
  id                  String        @id @default(uuid())
  commodityType       CommodityType @map("commodity_type")
  year                Int
  forecastDate        DateTime      @map("forecast_date")

  // Yield estimates
  projectedYield      Decimal       @map("projected_yield") @db.Decimal(6, 2) // bu/acre
  trendYield          Decimal?      @map("trend_yield") @db.Decimal(6, 2)
  prevYearYield       Decimal?      @map("prev_year_yield") @db.Decimal(6, 2)
  avgYield5Yr         Decimal?      @map("avg_yield_5yr") @db.Decimal(6, 2)

  // Acreage
  plantedAcres        Decimal?      @map("planted_acres") @db.Decimal(12, 2) // Million acres
  harvestedAcres      Decimal?      @map("harvested_acres") @db.Decimal(12, 2)
  abandonedAcres      Decimal?      @map("abandoned_acres") @db.Decimal(12, 2)

  // Production estimate
  productionEstimate  Decimal?      @map("production_estimate") @db.Decimal(15, 2) // Million bushels

  // Change from previous
  yieldChange         Decimal?      @map("yield_change") @db.Decimal(6, 2)
  acreageChange       Decimal?      @map("acreage_change") @db.Decimal(12, 2)

  source              String        // "USDA_NASS", "PRO_FARMER", "ANALYST"
  sourceDetail        String?       @map("source_detail") // Specific analyst or tour name
  createdAt           DateTime      @default(now()) @map("created_at")

  @@index([commodityType, year])
  @@index([forecastDate])
  @@map("yield_forecasts")
}

// Market News and Sentiment
model MarketNews {
  id                  String        @id @default(uuid())
  title               String
  summary             String?
  content             String?
  source              String        // "REUTERS", "BLOOMBERG", "TWITTER", "USDA", etc.
  sourceUrl           String?       @map("source_url")
  publishedAt         DateTime      @map("published_at")

  // Categorization
  newsType            String        @map("news_type") // "TRADE", "WEATHER", "POLICY", "SUPPLY", "DEMAND", "TECHNICAL"
  relevantCommodities CommodityType[] @map("relevant_commodities")
  isBreakingNews      Boolean       @default(false) @map("is_breaking_news")
  importance          String        @default("MEDIUM") // "HIGH", "MEDIUM", "LOW"

  // AI-generated sentiment analysis
  sentimentScore      Decimal?      @map("sentiment_score") @db.Decimal(3, 2) // -1.0 to 1.0
  sentimentLabel      String?       @map("sentiment_label") // "BULLISH", "BEARISH", "NEUTRAL"
  priceImpact         String?       @map("price_impact") // "POSITIVE", "NEGATIVE", "NEUTRAL"
  aiAnalysis          String?       @map("ai_analysis") // Full AI analysis of the news

  // Key entities mentioned
  countriesMentioned  String[]      @map("countries_mentioned") // ["China", "Brazil", etc.]
  topicTags           String[]      @map("topic_tags") // ["tariffs", "drought", "exports"]

  analyzedAt          DateTime?     @map("analyzed_at")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@index([publishedAt])
  @@index([newsType])
  @@index([sentimentLabel])
  @@index([relevantCommodities])
  @@map("market_news")
}

// USDA Report Schedule (for alerting users)
model USDAReportSchedule {
  id                  String        @id @default(uuid())
  reportType          String        @map("report_type") // "WASDE", "CROP_PROGRESS", "EXPORT_SALES", "PLANTED_ACREAGE", "GRAIN_STOCKS"
  reportName          String        @map("report_name") // Friendly name
  releaseDate         DateTime      @map("release_date")
  releaseTime         String        @map("release_time") // "12:00 ET"
  commodities         CommodityType[]
  importance          String        @default("HIGH") // "HIGH", "MEDIUM", "LOW"
  notes               String?
  createdAt           DateTime      @default(now()) @map("created_at")

  @@index([releaseDate])
  @@index([reportType])
  @@map("usda_report_schedule")
}

// Seasonal Price Patterns (historical analysis)
model SeasonalPattern {
  id                  String        @id @default(uuid())
  commodityType       CommodityType @map("commodity_type")
  month               Int           // 1-12

  // Historical price patterns (% change from year average)
  avgPriceIndex       Decimal       @map("avg_price_index") @db.Decimal(5, 4) // e.g., 1.05 means 5% above annual avg
  highProbability     Decimal?      @map("high_probability") @db.Decimal(5, 4) // Probability this month is annual high
  lowProbability      Decimal?      @map("low_probability") @db.Decimal(5, 4) // Probability this month is annual low

  // Basis patterns
  avgBasisIndex       Decimal?      @map("avg_basis_index") @db.Decimal(5, 4)
  basisNarrowPct      Decimal?      @map("basis_narrow_pct") @db.Decimal(5, 4) // % of years basis narrows this month

  // Marketing recommendations
  historicalSellPct   Decimal?      @map("historical_sell_pct") @db.Decimal(5, 4) // % typically marketed by this month
  recommendedAction   String?       @map("recommended_action") // Brief recommendation

  yearsAnalyzed       Int           @default(10) @map("years_analyzed")
  lastUpdated         DateTime      @default(now()) @map("last_updated")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@unique([commodityType, month])
  @@index([commodityType])
  @@map("seasonal_patterns")
}

// Commitment of Traders (COT) Data - Fund Positioning
model CommitmentOfTraders {
  id                  String        @id @default(uuid())
  commodityType       CommodityType @map("commodity_type")
  reportDate          DateTime      @map("report_date")

  // Managed Money (Fund) Positions (contracts)
  mmLong              Int?          @map("mm_long") // Managed Money Long
  mmShort             Int?          @map("mm_short") // Managed Money Short
  mmNet               Int?          @map("mm_net") // Net position (long - short)
  mmNetChange         Int?          @map("mm_net_change") // Change from previous week

  // Commercial Positions (hedgers)
  commLong            Int?          @map("comm_long")
  commShort           Int?          @map("comm_short")
  commNet             Int?          @map("comm_net")
  commNetChange       Int?          @map("comm_net_change")

  // Open Interest
  openInterest        Int?          @map("open_interest")
  openInterestChange  Int?          @map("open_interest_change")

  // Percentile rankings (where current position falls in history)
  mmNetPercentile     Decimal?      @map("mm_net_percentile") @db.Decimal(5, 2) // 0-100

  source              String        @default("CFTC")
  createdAt           DateTime      @default(now()) @map("created_at")

  @@unique([commodityType, reportDate])
  @@index([commodityType])
  @@index([reportDate])
  @@map("commitment_of_traders")
}
