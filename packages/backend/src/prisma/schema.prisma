// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  OWNER
  MANAGER
  EMPLOYEE
  RETAILER
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum CropYear {
  NEW_CROP
  OLD_CROP
}

enum ContractType {
  CASH
  BASIS
  HTA
  ACCUMULATOR
}

enum CommodityType {
  CORN
  SOYBEANS
  WHEAT
}

enum BidRequestStatus {
  OPEN
  CLOSED
}

enum ScaleTicketStatus {
  PENDING
  PARSED
  FAILED
  PROCESSED
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  role          UserRole
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  businessMemberships BusinessMember[]
  calendarEvents      CalendarEvent[]
  createdTasks        Task[]          @relation("TaskCreator")
  assignedTasks       Task[]          @relation("TaskAssignee")
  taskComments        TaskComment[]
  refreshTokens       RefreshToken[]
  pushSubscriptions   PushSubscription[]
  grainContracts      GrainContract[]
  priceAlerts         PriceAlert[]
  retailerProfile     Retailer?
  createdBidRequests  BidRequest[]
  createdInvitations  BusinessInvitation[] @relation("InvitationCreator")
  usedInvitations     BusinessInvitation[] @relation("InvitationUser")
  uploadedInvoices    Invoice[]       @relation("InvoiceUploader")
  uploadedScaleTickets ScaleTicket[]  @relation("ScaleTicketUploader")
  binTransactions     BinTransaction[] @relation("BinTransactionCreator")

  @@map("users")
}

model Business {
  id        String   @id @default(uuid())
  name      String
  address   String?  // Street address for deliveries
  city      String?
  state     String?
  zipCode   String?  @map("zip_code")
  phone     String?  // Contact phone for delivery coordination
  email     String?  // Contact email for delivery coordination
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  members        BusinessMember[]
  calendarEvents CalendarEvent[]
  tasks          Task[]
  grainEntities  GrainEntity[]
  priceAlerts    PriceAlert[]
  fertilizers    Fertilizer[]
  chemicals      Chemical[]
  seedHybrids    SeedHybrid[]
  bidRequests    BidRequest[]
  invitations    BusinessInvitation[]
  invoices       Invoice[]
  purchaseHistory PurchaseHistory[]
  scaleTickets   ScaleTicket[]

  @@index([latitude, longitude])
  @@map("businesses")
}

model BusinessMember {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  businessId String   @map("business_id")
  role       UserRole
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
  @@map("business_members")
}

model BusinessInvitation {
  id             String    @id @default(uuid())
  businessId     String    @map("business_id")
  code           String    @unique // 8-character alphanumeric code
  role           UserRole  // Role the invitee will have (MANAGER or EMPLOYEE)
  createdBy      String    @map("created_by")
  email          String?   // Optional: specific email to restrict invitation
  expiresAt      DateTime  @map("expires_at")
  usedAt         DateTime? @map("used_at")
  usedBy         String?   @map("used_by")
  isActive       Boolean   @default(true) @map("is_active")
  maxUses        Int       @default(1) @map("max_uses") // How many times can this code be used
  currentUses    Int       @default(0) @map("current_uses")
  createdAt      DateTime  @default(now()) @map("created_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator  User     @relation("InvitationCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  user     User?    @relation("InvitationUser", fields: [usedBy], references: [id])

  @@index([businessId])
  @@index([code])
  @@index([createdBy])
  @@map("business_invitations")
}

model CalendarEvent {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  userId      String   @map("user_id")
  title       String
  description String?
  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")
  allDay      Boolean  @default(false) @map("all_day")
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([businessId, startTime])
  @@index([userId, startTime])
  @@map("calendar_events")
}

model Task {
  id           String       @id @default(uuid())
  businessId   String       @map("business_id")
  createdBy    String       @map("created_by")
  assignedTo   String?      @map("assigned_to")
  title        String
  description  String?
  status       TaskStatus   @default(OPEN)
  priority     TaskPriority @default(MEDIUM)
  dueDate      DateTime?    @map("due_date")
  completedAt  DateTime?    @map("completed_at")
  isClaimable  Boolean      @default(false) @map("is_claimable")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  business Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator  User          @relation("TaskCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  assignee User?         @relation("TaskAssignee", fields: [assignedTo], references: [id], onDelete: SetNull)
  comments TaskComment[]

  @@index([businessId, status])
  @@index([assignedTo, status])
  @@map("tasks")
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  userId    String   @map("user_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@map("task_comments")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model PushSubscription {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  endpoint   String   @unique
  p256dh     String   // Public key for encryption
  auth       String   // Authentication secret
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model GrainEntity {
  id         String   @id @default(uuid())
  businessId String   @map("business_id")
  name       String   // Rittgers Grain, Rittgers Farm, JDR AG, JVR AG, JKC Farms
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business              @relation(fields: [businessId], references: [id], onDelete: Cascade)
  contracts   GrainContract[]
  productions CropYearProduction[]
  farms       Farm[]
  grainBins   GrainBin[]

  @@unique([businessId, name])
  @@index([businessId])
  @@map("grain_entities")
}

model GrainContract {
  id                 String         @id @default(uuid())
  grainEntityId      String         @map("grain_entity_id")
  createdBy          String         @map("created_by")
  contractType       ContractType   @map("contract_type")
  cropYear           CropYear       @map("crop_year")
  year               Int            @default(2025) // Actual year: 2024, 2025, 2026, etc.
  commodityType      CommodityType  @map("commodity_type")
  contractNumber     String?        @map("contract_number")
  buyer              String         // Elevator/Buyer name
  totalBushels       Decimal        @map("total_bushels") @db.Decimal(12, 2)
  deliveryStartDate  DateTime?      @map("delivery_start_date")
  deliveryEndDate    DateTime?      @map("delivery_end_date")

  // Pricing fields
  cashPrice          Decimal?       @map("cash_price") @db.Decimal(10, 4)
  basisPrice         Decimal?       @map("basis_price") @db.Decimal(10, 4)
  futuresMonth       String?        @map("futures_month") // e.g., "Dec 2024"
  futuresPrice       Decimal?       @map("futures_price") @db.Decimal(10, 4)

  // Status
  bushelsDelivered   Decimal        @default(0) @map("bushels_delivered") @db.Decimal(12, 2)
  isActive           Boolean        @default(true) @map("is_active")

  notes              String?
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")

  // Relations
  grainEntity        GrainEntity           @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)
  createdByUser      User                  @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  accumulatorDetails AccumulatorDetails?
  binTransactions    BinTransaction[]

  @@index([grainEntityId, cropYear])
  @@index([contractType, isActive])
  @@index([grainEntityId, year, commodityType])
  @@map("grain_contracts")
}

model AccumulatorDetails {
  id                    String                   @id @default(uuid())
  contractId            String                   @unique @map("contract_id")
  knockoutPrice         Decimal                  @map("knockout_price") @db.Decimal(10, 4)
  doubleUpPrice         Decimal                  @map("double_up_price") @db.Decimal(10, 4)
  dailyBushels          Decimal                  @map("daily_bushels") @db.Decimal(12, 2)
  totalBushelsMarketed  Decimal                  @default(0) @map("total_bushels_marketed") @db.Decimal(12, 2)
  startDate             DateTime                 @map("start_date")
  endDate               DateTime?                @map("end_date")
  isDailyDouble         Boolean                  @default(false) @map("is_daily_double")
  isCurrentlyDoubled    Boolean                  @default(false) @map("is_currently_doubled")
  knockoutReached       Boolean                  @default(false) @map("knockout_reached")
  knockoutDate          DateTime?                @map("knockout_date")
  basisLocked           Boolean                  @default(false) @map("basis_locked")
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  // Relations
  contract              GrainContract            @relation(fields: [contractId], references: [id], onDelete: Cascade)
  dailyEntries          AccumulatorDailyEntry[]

  @@map("accumulator_details")
}

model AccumulatorDailyEntry {
  id                  String             @id @default(uuid())
  accumulatorId       String             @map("accumulator_id")
  date                DateTime
  bushelsMarketed     Decimal            @map("bushels_marketed") @db.Decimal(12, 2)
  marketPrice         Decimal            @map("market_price") @db.Decimal(10, 4)
  wasDoubledUp        Boolean            @default(false) @map("was_doubled_up")
  notes               String?
  createdAt           DateTime           @default(now()) @map("created_at")

  // Relations
  accumulator         AccumulatorDetails @relation(fields: [accumulatorId], references: [id], onDelete: Cascade)

  @@unique([accumulatorId, date])
  @@index([accumulatorId])
  @@map("accumulator_daily_entries")
}

model CropYearProduction {
  id              String        @id @default(uuid())
  grainEntityId   String        @map("grain_entity_id")
  commodityType   CommodityType @map("commodity_type")
  year            Int           // Actual year: 2024, 2025, 2026, etc.
  acres           Decimal       @db.Decimal(12, 2)
  bushelsPerAcre  Decimal       @map("bushels_per_acre") @db.Decimal(10, 2)
  totalProjected  Decimal       @map("total_projected") @db.Decimal(12, 2)
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  grainEntity     GrainEntity   @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)

  @@unique([grainEntityId, commodityType, year])
  @@index([grainEntityId, year])
  @@index([commodityType, year])
  @@map("crop_year_productions")
}

model MarketPrice {
  id            String        @id @default(uuid())
  commodityType CommodityType @map("commodity_type")
  price         Decimal       @db.Decimal(10, 4)
  priceDate     DateTime      @map("price_date")
  source        String        // 'USDA_NASS', 'CME', etc.
  marketType    String        @default("SPOT") @map("market_type") // 'SPOT', 'FUTURES'
  contractMonth String?       @map("contract_month")
  createdAt     DateTime      @default(now()) @map("created_at")

  @@index([commodityType, priceDate])
  @@index([priceDate])
  @@map("market_prices")
}

model PriceAlert {
  id              String        @id @default(uuid())
  businessId      String        @map("business_id")
  userId          String        @map("user_id")
  commodityType   CommodityType @map("commodity_type")
  targetPrice     Decimal       @map("target_price") @db.Decimal(10, 4)
  alertType       String        @map("alert_type") // 'ABOVE', 'BELOW'
  isActive        Boolean       @default(true) @map("is_active")
  lastTriggered   DateTime?     @map("last_triggered")
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  business        Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([businessId, isActive])
  @@index([commodityType, isActive])
  @@map("price_alerts")
}

// ===== Break-Even Calculator Models =====

model Fertilizer {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  name        String   // MAP, DAP, MESZ, POTASH, LIME, UREA, UAN(32%), SULFUR, etc.
  pricePerUnit Decimal @map("price_per_unit") @db.Decimal(10, 2) // Price per lb or gallon
  unit        String   // "LB" or "GAL"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  usage       FarmFertilizerUsage[]

  @@map("fertilizers")
  @@index([businessId])
}

model Chemical {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  name        String
  pricePerUnit Decimal @map("price_per_unit") @db.Decimal(10, 2) // Price per gallon or lb
  unit        String   // "LB" or "GAL"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  usage       FarmChemicalUsage[]

  @@map("chemicals")
  @@index([businessId])
}

model SeedHybrid {
  id          String        @id @default(uuid())
  businessId  String        @map("business_id")
  name        String        // Hybrid name
  commodityType CommodityType @map("commodity_type") // CORN, SOYBEANS, WHEAT
  pricePerBag Decimal       @map("price_per_bag") @db.Decimal(10, 2)
  seedsPerBag Int           @map("seeds_per_bag") // Number of seeds in a bag
  isActive    Boolean       @default(true) @map("is_active")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  usage       FarmSeedUsage[]

  @@map("seed_hybrids")
  @@index([businessId])
  @@index([commodityType])
}

model Farm {
  id            String        @id @default(uuid())
  grainEntityId String        @map("grain_entity_id")
  name          String        // "North 40", "South Farm", etc.
  acres         Decimal       @db.Decimal(10, 2)
  commodityType CommodityType @map("commodity_type") // CORN, SOYBEANS, WHEAT
  year          Int           // Crop year
  projectedYield Decimal      @default(0) @map("projected_yield") @db.Decimal(10, 2) // Projected bushels per acre
  aph           Decimal       @default(0) @db.Decimal(10, 2) // Actual Production History (APH)
  notes         String?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  grainEntity   GrainEntity @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)

  // Cost tracking relations
  fertilizerUsage FarmFertilizerUsage[]
  chemicalUsage   FarmChemicalUsage[]
  seedUsage       FarmSeedUsage[]
  otherCosts      FarmOtherCost[]

  @@map("farms")
  @@index([grainEntityId])
  @@index([year])
  @@unique([grainEntityId, name, year])
}

model FarmFertilizerUsage {
  id           String   @id @default(uuid())
  farmId       String   @map("farm_id")
  fertilizerId String   @map("fertilizer_id")
  amountUsed   Decimal  @map("amount_used") @db.Decimal(10, 2) // Total pounds or gallons (calculated from ratePerAcre * acresApplied)
  ratePerAcre  Decimal? @map("rate_per_acre") @db.Decimal(10, 4) // Application rate per acre (e.g., 150 lbs/acre)
  acresApplied Decimal? @map("acres_applied") @db.Decimal(10, 2) // Acres this fertilizer was applied to
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  farm         Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  fertilizer   Fertilizer @relation(fields: [fertilizerId], references: [id], onDelete: Cascade)

  @@map("farm_fertilizer_usage")
  @@index([farmId])
  @@index([fertilizerId])
}

model FarmChemicalUsage {
  id           String   @id @default(uuid())
  farmId       String   @map("farm_id")
  chemicalId   String   @map("chemical_id")
  amountUsed   Decimal  @map("amount_used") @db.Decimal(10, 2) // Total pounds or gallons (calculated from ratePerAcre * acresApplied)
  ratePerAcre  Decimal? @map("rate_per_acre") @db.Decimal(10, 4) // Application rate per acre (e.g., 2.5 gal/acre)
  acresApplied Decimal? @map("acres_applied") @db.Decimal(10, 2) // Acres this chemical was applied to
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  farm         Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  chemical     Chemical @relation(fields: [chemicalId], references: [id], onDelete: Cascade)

  @@map("farm_chemical_usage")
  @@index([farmId])
  @@index([chemicalId])
}

model FarmSeedUsage {
  id             String   @id @default(uuid())
  farmId         String   @map("farm_id")
  seedHybridId   String   @map("seed_hybrid_id")
  bagsUsed       Decimal  @map("bags_used") @db.Decimal(10, 2) // Total bags used (calculated from population * acresApplied / seedsPerBag)
  ratePerAcre    Decimal? @map("rate_per_acre") @db.Decimal(10, 2) // Seeding rate (population - seeds per acre, e.g., 32000)
  acresApplied   Decimal? @map("acres_applied") @db.Decimal(10, 2) // Acres this seed was applied to
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  farm           Farm       @relation(fields: [farmId], references: [id], onDelete: Cascade)
  seedHybrid     SeedHybrid @relation(fields: [seedHybridId], references: [id], onDelete: Cascade)

  @@map("farm_seed_usage")
  @@index([farmId])
  @@index([seedHybridId])
}

model FarmOtherCost {
  id          String   @id @default(uuid())
  farmId      String   @map("farm_id")
  costType    String   @map("cost_type") // "LAND_RENT", "INSURANCE", "CUSTOM_WORK", "FUEL", "LABOR", "OTHER"
  amount      Decimal  @db.Decimal(10, 2) // Total amount or per-acre amount
  isPerAcre   Boolean  @default(false) @map("is_per_acre") // If true, multiply by acres
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  farm        Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@map("farm_other_costs")
  @@index([farmId])
  @@index([costType])
}

// ===== Input Bidding System Models =====

model Retailer {
  id                String   @id @default(uuid())
  userId            String   @unique @map("user_id")
  companyName       String   @map("company_name")
  businessLicense   String?  @map("business_license")
  phone             String?
  address           String?  // Street address for delivery
  city              String?
  state             String?
  zipCode           String?  @map("zip_code")
  latitude          Decimal? @db.Decimal(10, 8)
  longitude         Decimal? @db.Decimal(11, 8)
  radiusPreference  Int      @default(50) @map("radius_preference")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bids              RetailerBid[]

  @@index([latitude, longitude])
  @@map("retailers")
}

model BidRequest {
  id                  String             @id @default(uuid())
  businessId          String             @map("business_id")
  createdBy           String             @map("created_by")
  title               String
  description         String?
  status              BidRequestStatus   @default(OPEN)
  bidDeadline         DateTime?          @map("bid_deadline")
  desiredDeliveryDate DateTime?          @map("desired_delivery_date")
  notes               String?
  createdAt           DateTime           @default(now()) @map("created_at")
  updatedAt           DateTime           @updatedAt @map("updated_at")
  closedAt            DateTime?          @map("closed_at")

  // Relations
  business            Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  creator             User               @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  items               BidRequestItem[]
  bids                RetailerBid[]
  sourceInvoice       Invoice[]

  @@map("bid_requests")
  @@index([businessId])
  @@index([status])
}

model BidRequestItem {
  id            String   @id @default(uuid())
  bidRequestId  String   @map("bid_request_id")
  productType   String   @map("product_type")  // "FERTILIZER" or "CHEMICAL"
  productId     String?  @map("product_id")     // Optional FK to Fertilizer or Chemical
  productName   String   @map("product_name")   // Stored for flexibility
  quantity      Decimal  @db.Decimal(10, 2)
  unit          String   // "LB" or "GAL"
  startingPrice Decimal? @map("starting_price") @db.Decimal(10, 2)  // Farmer's original target price (or first retailer bid if left blank) - never changes
  currentPrice  Decimal? @map("current_price") @db.Decimal(10, 2)  // Current best bid price - updates when lower bid received
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  bidRequest    BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)

  @@map("bid_request_items")
  @@index([bidRequestId])
}

enum RetailerBidStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model RetailerBid {
  id                      String             @id @default(uuid())
  bidRequestId            String             @map("bid_request_id")
  retailerId              String             @map("retailer_id")
  status                  RetailerBidStatus  @default(PENDING)
  totalDeliveredPrice     Decimal            @map("total_delivered_price") @db.Decimal(12, 2)
  guaranteedDeliveryDate  DateTime           @map("guaranteed_delivery_date")
  expirationDate          DateTime?          @map("expiration_date")  // Date when bid expires
  termsAcknowledged       Boolean            @default(false) @map("terms_acknowledged")
  notes                   String?
  acceptedAt              DateTime?          @map("accepted_at")  // When farmer accepted
  acceptedBy              String?            @map("accepted_by")  // User ID who accepted
  createdAt               DateTime           @default(now()) @map("created_at")
  updatedAt               DateTime           @updatedAt @map("updated_at")

  // Relations
  bidRequest              BidRequest @relation(fields: [bidRequestId], references: [id], onDelete: Cascade)
  retailer                Retailer   @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  bidItems                RetailerBidItem[]

  @@unique([bidRequestId, retailerId])
  @@map("retailer_bids")
  @@index([retailerId])
  @@index([bidRequestId])
  @@index([status])
}

model RetailerBidItem {
  id                String      @id @default(uuid())
  retailerBidId     String      @map("retailer_bid_id")
  bidRequestItemId  String      @map("bid_request_item_id")
  pricePerUnit      Decimal     @map("price_per_unit") @db.Decimal(10, 2)
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relations
  retailerBid       RetailerBid @relation(fields: [retailerBidId], references: [id], onDelete: Cascade)

  @@map("retailer_bid_items")
  @@index([retailerBidId])
  @@index([bidRequestItemId])
}

// ===== Invoice Parsing System Models =====

enum InvoiceStatus {
  PENDING    // Upload complete, parsing in progress
  PARSED     // Successfully parsed
  FAILED     // Parsing failed
  REVIEWED   // User reviewed and locked prices
}

enum InvoiceProductType {
  FERTILIZER
  CHEMICAL
  SEED
}

model Invoice {
  id                  String          @id @default(uuid())
  businessId          String          @map("business_id")
  uploadedBy          String          @map("uploaded_by")
  fileName            String          @map("file_name")
  filePath            String          @map("file_path")
  fileSize            Int             @map("file_size")
  mimeType            String          @map("mime_type")
  status              InvoiceStatus   @default(PENDING)

  vendorName          String?         @map("vendor_name")
  invoiceNumber       String?         @map("invoice_number")
  invoiceDate         DateTime?       @map("invoice_date")
  totalAmount         Decimal?        @map("total_amount") @db.Decimal(12, 2)

  parsedData          Json?           @map("parsed_data")
  parseError          String?         @map("parse_error")
  parsedAt            DateTime?       @map("parsed_at")

  createdBidRequestId String?         @map("created_bid_request_id")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  // Relations
  business            Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)
  uploader            User            @relation("InvoiceUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  lineItems           InvoiceLineItem[]
  createdBidRequest   BidRequest?     @relation(fields: [createdBidRequestId], references: [id], onDelete: SetNull)

  @@map("invoices")
  @@index([businessId, status])
  @@index([uploadedBy])
}

model InvoiceLineItem {
  id                  String               @id @default(uuid())
  invoiceId           String               @map("invoice_id")
  productType         InvoiceProductType   @map("product_type")
  productName         String               @map("product_name")
  quantity            Decimal              @db.Decimal(10, 2)
  unit                String
  pricePerUnit        Decimal              @map("price_per_unit") @db.Decimal(10, 2)
  totalPrice          Decimal              @map("total_price") @db.Decimal(12, 2)
  ratePerAcre         Decimal?             @map("rate_per_acre") @db.Decimal(10, 4)
  rateUnit            String?              @map("rate_unit")

  matchedProductId    String?              @map("matched_product_id")
  matchedProductType  InvoiceProductType?  @map("matched_product_type")
  isNewProduct        Boolean              @default(false) @map("is_new_product")

  priceLockedAt       DateTime?            @map("price_locked_at")
  priceLockedBy       String?              @map("price_locked_by")

  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")

  // Relations
  invoice             Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  purchaseHistory     PurchaseHistory?

  @@map("invoice_line_items")
  @@index([invoiceId])
  @@index([productType])
}

model PurchaseHistory {
  id                  String               @id @default(uuid())
  businessId          String               @map("business_id")
  invoiceLineItemId   String               @unique @map("invoice_line_item_id")

  productType         InvoiceProductType   @map("product_type")
  productId           String?              @map("product_id")
  productName         String               @map("product_name")

  purchasedQuantity   Decimal              @map("purchased_quantity") @db.Decimal(10, 2)
  purchasedUnit       String               @map("purchased_unit")
  purchasedPrice      Decimal              @map("purchased_price") @db.Decimal(10, 2)
  totalCost           Decimal              @map("total_cost") @db.Decimal(12, 2)

  purchasedAt         DateTime             @map("purchased_at")
  vendorName          String?              @map("vendor_name")

  createdAt           DateTime             @default(now()) @map("created_at")

  // Relations
  business            Business             @relation(fields: [businessId], references: [id], onDelete: Cascade)
  invoiceLineItem     InvoiceLineItem      @relation(fields: [invoiceLineItemId], references: [id], onDelete: Cascade)

  @@map("purchase_history")
  @@index([businessId, productType])
  @@index([productId])
  @@index([purchasedAt])
}

// ===== Grain Bin Storage Tracker Models =====

model GrainBin {
  id              String        @id @default(uuid())
  grainEntityId   String        @map("grain_entity_id")
  name            String        // "North Bin", "West Storage"
  capacity        Decimal       @db.Decimal(12, 2)
  currentBushels  Decimal       @default(0) @map("current_bushels") @db.Decimal(12, 2)
  commodityType   CommodityType @map("commodity_type")
  cropYear        Int           @map("crop_year") // 2023, 2024, 2025
  notes           String?
  isActive        Boolean       @default(true) @map("is_active")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  grainEntity     GrainEntity   @relation(fields: [grainEntityId], references: [id], onDelete: Cascade)
  scaleTickets    ScaleTicket[]
  binTransactions BinTransaction[]

  @@index([grainEntityId, commodityType])
  @@index([cropYear])
  @@map("grain_bins")
}

model ScaleTicket {
  id              String             @id @default(uuid())
  businessId      String             @map("business_id")
  uploadedBy      String             @map("uploaded_by")
  binId           String?            @map("bin_id")
  fileName        String             @map("file_name")
  filePath        String             @map("file_path")
  fileSize        Int                @map("file_size")
  mimeType        String             @map("mime_type")
  status          ScaleTicketStatus  @default(PENDING)

  // Parsed data
  loadNumber      String?            @map("load_number")
  ticketDate      DateTime?          @map("ticket_date")
  netBushels      Decimal?           @map("net_bushels") @db.Decimal(12, 2)
  moisture        Decimal?           @db.Decimal(5, 2)
  testWeight      Decimal?           @map("test_weight") @db.Decimal(5, 2)
  commodityType   CommodityType?     @map("commodity_type")
  buyer           String?

  parsedData      Json?              @map("parsed_data")
  parseError      String?            @map("parse_error")
  parsedAt        DateTime?          @map("parsed_at")
  processedAt     DateTime?          @map("processed_at")

  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  business        Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)
  uploader        User               @relation("ScaleTicketUploader", fields: [uploadedBy], references: [id], onDelete: Cascade)
  bin             GrainBin?          @relation(fields: [binId], references: [id], onDelete: SetNull)
  binTransaction  BinTransaction?

  @@map("scale_tickets")
  @@index([businessId, status])
  @@index([binId])
}

model BinTransaction {
  id              String              @id @default(uuid())
  binId           String              @map("bin_id")
  type            String              // "ADDITION", "REMOVAL", "SALE", "ADJUSTMENT"
  bushels         Decimal             @db.Decimal(12, 2)
  description     String?
  scaleTicketId   String?             @unique @map("scale_ticket_id")
  grainContractId String?             @map("grain_contract_id")
  createdBy       String              @map("created_by")
  transactionDate DateTime            @default(now()) @map("transaction_date")
  createdAt       DateTime            @default(now()) @map("created_at")

  // Relations
  bin             GrainBin            @relation(fields: [binId], references: [id], onDelete: Cascade)
  scaleTicket     ScaleTicket?        @relation(fields: [scaleTicketId], references: [id], onDelete: SetNull)
  grainContract   GrainContract?      @relation(fields: [grainContractId], references: [id], onDelete: SetNull)
  user            User                @relation("BinTransactionCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("bin_transactions")
  @@index([binId])
  @@index([transactionDate])
}
